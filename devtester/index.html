<!doctype html>
<html>
	<head>
		<title>Идентификация браузера</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta charset="utf-8">

		<script src="http://code.jquery.com/jquery-1.12.1.min.js"></script>
		<script src="js/fingerprint2.js"></script>

		<style>
		    body{
		      font-family: sans-serif;
		      max-width: 48em;
		      margin: auto;
		      padding: 0 5%;
		      background: #ECEDF2;
		      color: #23556D;
		    }

		    h1 {
		      margin: 2em 0 0;
		    }

		    p {
		      font-size: 1.2em
		    }

		    a { 
				text-decoration: none;
				} 

		    button {
		      border: none;
		      color: #fff;
		      font-size: 1.2em;
		      background: #31C949;
		      padding: 0.5em 0.75em 0.6em;
		      border-radius: 3px;
		      box-shadow: 0 3px 0 #35AC47;
		      outline: none;
		    }

		    button:active {
		      transform: translateY(3px);
		      box-shadow: none;
		    }


		    /*@media (min-width: 32em) {
		      h1 {
		        font-size: 4em;
		      }

		      strong {
		        font-size: 1.5em;
		      }
		    }*/
		</style>
	</head>

	<body>
		<h1>Идентификация мобильного браузера</h1>

		<p>Браузер: <text id="brow"></text></p>
		<p>Идентификатор браузера: <text id="brid"></text></p>
		<p>Время расчета: <text id="time"/></p>

		<p id="result"></p>

		<button type="button" id="btn">Расчитать и отправить</button>

		<p><small><a href="https://vk.com/bildeyko">Мне</a> отправится только версия вашего браузера, полученный идентификатор и время, затраченное на получение. Разработано с использованием <a href="https://github.com/Valve/fingerprintjs2">Fingerprintjs2</a></small></p>

		<script>
			window.onload = function() {
				var userAgent = navigator.userAgent;
			    $("#brow").text(userAgent);
			};

			$("#btn").on("click", function () {
				var date1 = new Date();
				var fp = new Fingerprint2();

				fp.get(function(result) {
					var date2 = new Date();
					var resultTime1 = (date2 - date1)
					var timeString1 = resultTime1 + "ms";
					
					$("#brid").text(result);
					$("#time").text(timeString1);

					date1 = new Date();
						fp.get(function(result) {
							var date2 = new Date();
							var resultTime2 = (date2 - date1)
							var timeString2 = resultTime2 + "ms";
							
							$("#brid").text(result);

							var userAgent = navigator.userAgent;

							sendMail(result, resultTime1, resultTime2, userAgent);
						});
				});
			});

			function sendMail(Id, Time1, Time2, Agent) {
				console.log(Id);

				var mailBody = Agent + "<br>" + Id + "<br>" +Time1+ "<br>"+Time2; 

				$.ajax({
					type: "POST",
					url: "http://api.iquiz.win/tools/fingerprintSave",
					data:
					{
						'useragent':Agent,
						'device_id':Id,
						'time1':Time1,
						'time2':Time2
					},
					success: function(msg) 
					{
						if ('error_code' in msg) {
							$("#result").text("Упс. Какая-то ошибка. Попробуйте еще раз.");
						} else {
							$("#result").text("Спасибо за помощь");
						}
					},
					error: function(num)
					{
						$("#result").text("Упс. Какая-то ошибка. Попробуйте еще раз.");
					}
				});
			};
		</script>
	</body>
</html>